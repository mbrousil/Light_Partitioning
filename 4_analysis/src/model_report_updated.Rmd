---
title: "Light partitioning model update"
output: html_document
date: "`r Sys.Date()`"
---

### Load data
```{r}
tar_load(simultaneous_data_strict)
tar_load(ecoregion)
```

### L1 Ecoregions
```{r}
ecoregion %>%
  distinct(NA_L1CODE, NA_L1NAME, NA_L1KEY) %>%
  mutate(NA_L1CODE = as.numeric(NA_L1CODE)) %>%
  arrange(NA_L1CODE)
```

Prepare data for ecoregion join
```{r}
simul_sf <- simultaneous_data_strict %>%
  ungroup() %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = 4326) %>%
  st_transform(crs = st_crs(ecoregion))

ggplot() +
  geom_sf(data = ecoregion) +
  geom_sf(data = simul_sf)

simul_region <- st_join(x = simul_sf,
                        y = ecoregion,
                        left = TRUE)

ggplot() +
  geom_sf(data = ecoregion,
          aes(fill = NA_L1NAME),
          alpha = 0.7) +
  geom_sf(data = simul_region,
          aes(fill = NA_L1NAME),
          color = "black", pch = 21) +
  theme_bw()
```

### Modeling
```{r}

# Original modeling -------------------------------------------------------

nap <- expand_grid(simultaneous_data_strict, chl_ratio = 234) %>%
  mutate(power = ifelse(chl_ratio == 234, 0.57, 1),
         chla_biomass = exp(log(chl_ratio / 1000) + log(chla) * power),
         tss_dead = tss - chla_biomass)

nap_est <- nap %>%
  filter(tss_dead > 0.001) %>%
  mutate(secchi = ifelse(secchi < 0.01, 0.01, secchi),
         kd = (1 / secchi))

nap_model <- lm(kd ~ tss_dead + doc + chla, data = nap_est)

nap_resid <- nap_est %>%
  mutate(residuals = nap_model$residuals,
         pred = nap_model$fitted.values)


# Model by ecoregion ------------------------------------------------------

nap_est_eco <- simul_region %>%
  as_tibble() %>%
  expand_grid(., chl_ratio = 234) %>%
  mutate(power = ifelse(chl_ratio == 234, 0.57, 1),
         chla_biomass = exp(log(chl_ratio / 1000) + log(chla) * power),
         tss_dead = tss - chla_biomass) %>%
  filter(tss_dead > 0.001) %>%
  mutate(secchi = ifelse(secchi < 0.01, 0.01, secchi),
         kd = (1 / secchi)) %>%
  split(f = .$NA_L1NAME)


model_eco <- map(.x = nap_est_eco,
                 .f = ~ lm(kd ~ tss_dead + doc + chla, data = .x))

nap_resid_eco <- map2(.x = nap_est_eco,
                      .y = model_eco,
                      .f = ~ .x %>%
                        mutate(residuals = .y$residuals,
                               pred = .y$fitted.values))

model_metrics_eco <- pmap_df(.l = list(nap_resid = nap_resid_eco,
                                       name = names(nap_resid_eco),
                                       model = model_eco),
                             .f = function(nap_resid, name, model){
                               # Which dataset used for the model?
                               dataset <- name
                               # RMSE
                               rmse <- round(rmse(nap_resid$kd, nap_resid$pred), 2)
                               # Global model info
                               model_summary <- glance(model)
                               
                               # Get coefficients from the model and format
                               model_coefs <- as.data.frame(coef(model)) %>%
                                 rownames_to_column() %>%
                                 rename(coef = 2) %>%
                                 mutate(names = janitor::make_clean_names(rowname) %>%
                                          paste0(., "_coef")) %>%
                                 select(-rowname) %>%
                                 pivot_wider(names_from = "names", values_from = "coef")
                               
                               tibble(dataset = dataset,
                                      n_samples = model_summary$nobs,
                                      rmse = rmse,
                                      adj_rsq = model_summary$adj.r.squared,
                                      p_value = model_summary$p.value) %>%
                                 bind_cols(., model_coefs)
                             })

model_metrics_eco %>%
  kable() %>%
  kable_paper()
```